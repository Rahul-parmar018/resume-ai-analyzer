{% extends "base.html" %}
{% load static %}
{% block content %}

<section class="section-dark py-5" style="min-height: 80vh;">
  <div class="container container-custom">
    <!-- Breadcrumb -->
    <nav class="mb-4 sa fade-up" aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-secondary text-decoration-none">Home</a></li>
        <li class="breadcrumb-item active text-primary" aria-current="page">Score Checker</li>
      </ol>
    </nav>

    <div class="text-center mb-5 sa fade-up">
      <h1 class="display-4 fw-bold text-primary mb-3">Resume Score Checker</h1>
      <p class="lead text-muted mx-auto" style="max-width: 700px;">
        Upload your resume and let our AI analyze it for overall quality, ATS compatibility, and keyword density.
      </p>
    </div>

    <!-- MAIN UPLOAD CARD -->
    <div class="mx-auto sa fade-up" style="max-width: 800px;">
      <div class="product-card p-4 p-lg-5">
        <div class="upload-zone-wrapper">
          <div id="checkerDrop" class="upload-dropzone">
            <input id="checkerInput" type="file" class="d-none" accept=".pdf,.doc,.docx">
            <div class="upload-content text-center">
              <div class="upload-icon-pulse mb-4">
                <i class="bi bi-cloud-arrow-up"></i>
              </div>
              <h3 class="h4 text-primary mb-2">Drag & Drop Your Resume</h3>
              <p class="text-muted mb-4">Supported formats: <span class="text-primary fw-medium">PDF, DOCX</span></p>
              <button type="button" class="btn btn-brand btn-lg px-5 py-3" id="checkerBrowse">
                <i class="bi bi-folder-plus me-2"></i> Browse Files
              </button>
            </div>
          </div>
        </div>

        <div id="checkerFiles" class="dz-list mt-4"
          style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center;"></div>

        <div class="d-grid mt-5">
          <button id="checkScoreBtn" type="button" class="btn btn-primary-glow btn-lg py-3" disabled>
            <i class="bi bi-rocket-takeoff me-2"></i> Analyze Resume
          </button>
        </div>
      </div>
    </div>

    <!-- PLACEHOLDER RESULTS SECTION -->
    <div id="scoreResults" class="mt-5 pt-5 d-none sa fade-up">
      <div class="text-center mb-5">
        <h2 class="h1 fw-bold text-primary mb-2">Analysis Results</h2>
        <div class="badge bg-primary-glow px-4 py-2 rounded-pill">AI Processed</div>
      </div>

      <div class="row g-4">
        <!-- Overall Score Donut -->
        <div class="col-lg-5">
          <div class="product-card h-100 flex-center p-5">
            <div id="donut" class="premium-donut" aria-label="Total score">
              <svg viewBox="0 0 100 100" class="donut-svg">
                <circle class="donut-base" cx="50" cy="50" r="45"></circle>
                <circle id="donutFill" class="donut-fill" cx="50" cy="50" r="45" style="stroke-dasharray: 0, 283;">
                </circle>
              </svg>
              <div class="donut-content text-center">
                <div id="donutValue" class="display-3 fw-bold text-primary">0</div>
                <div class="text-muted text-uppercase tracking-widest small">Score</div>
              </div>
            </div>
            <div id="verdictText" class="mt-4 lead text-secondary text-center">Processing...</div>
          </div>
        </div>

        <!-- Section-wise Scores -->
        <div class="col-lg-7">
          <div class="product-card h-100 p-4 p-lg-5">
            <h4 class="text-primary mb-4">Section-wise Analysis</h4>
            <div class="subscore-item mb-4">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Education & Qualifications</span>
                <span id="scoreEdu" class="text-primary fw-bold">0%</span>
              </div>
              <div class="premium-progress">
                <div id="barEdu" class="progress-fill fill-cyan" style="width: 0%"></div>
              </div>
            </div>
            <div class="subscore-item mb-4">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Professional Experience</span>
                <span id="scoreExp" class="text-primary fw-bold">0%</span>
              </div>
              <div class="premium-progress">
                <div id="barExp" class="progress-fill fill-purple" style="width: 0%"></div>
              </div>
            </div>
            <div class="subscore-item mb-4">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Skills & Keywords</span>
                <span id="scoreSkills" class="text-primary fw-bold">0%</span>
              </div>
              <div class="premium-progress">
                <div id="barSkills" class="progress-fill fill-green" style="width: 0%"></div>
              </div>
            </div>
            <div class="subscore-item">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">ATS Compatibility</span>
                <span id="scoreATS" class="text-primary fw-bold">0%</span>
              </div>
              <div class="premium-progress">
                <div id="barATS" class="progress-fill fill-orange" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Feedback Card -->
        <div class="col-12">
          <div class="product-card product-card--glowing p-4 p-lg-5">
            <div class="d-flex align-items-center justify-content-between mb-4">
              <div class="d-flex align-items-center text-primary-glow">
                <i class="bi bi-chat-left-dots-fill fs-3 me-3"></i>
                <h3 class="h4 mb-0 text-primary">AI Feedback Summary</h3>
              </div>
              <a href="{% url 'review_resume' %}" class="btn btn-outline-brand">
                <i class="bi bi-search me-2"></i> View Detailed Review
              </a>
            </div>
            <div id="aiFeedback" class="text-muted lh-lg">
              <p>Analyzing your data to provide a detailed summary of your resume's strengths and areas for
                improvement...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- AI CONTEXT BLOCK -->
<section id="ai-context" class="section-dark py-5">
  <div class="container">
    <div class="ai-wrap mx-auto">
      <!-- Header -->
      <div class="ai-head text-center">
        <div class="emoji-pill bounce">ü§ñ</div>
        <h2 class="neon-title">Powered by AI</h2>
        <p class="ai-sub text-muted">A smart pipeline that reads, understands, and improves your resume.</p>
        <div class="ai-scan" aria-hidden="true"></div>
      </div>

      <!-- Holographic info cards -->
      <div class="row g-4 mt-2 eq-grid" id="aiEqGrid">
        <div class="col-lg-6">
          <div class="holo-card sa fade-up eq">
            <div class="holo-head"><span class="holo-emoji">‚ú®</span>
              <h3>What we do</h3>
            </div>
            <ul class="holo-list">
              <li>Parse and standardize sections (experience, skills, education, summary).</li>
              <li>Detect ATS blockers (headings, bullet consistency, parsable text, fonts).</li>
              <li>Check keyword coverage vs. role expectations and real job posts.</li>
              <li>Estimate clarity and signal density (action verbs + metrics).</li>
              <li>Prioritize quick wins with step‚Äëby‚Äëstep tips.</li>
            </ul>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="holo-card sa fade-up eq" data-sa-delay="70">
            <div class="holo-head"><span class="holo-emoji">üß†</span>
              <h3>How it works</h3>
            </div>
            <ol class="holo-steps">
              <li><strong>Parse & extract:</strong> Read your PDF/DOCX and normalize content.</li>
              <li><strong>Score:</strong> Compute subscores ‚Äî ATS, Match, Skills, Readability, Structure.</li>
              <li><strong>Find gaps:</strong> Spot missing must‚Äëhaves and weak bullets.</li>
              <li><strong>Guide:</strong> Give tailored suggestions; export a clean report.</li>
            </ol>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="holo-card sa fade-up eq">
            <div class="holo-head"><span class="holo-emoji">üöÄ</span>
              <h3>Why it's useful</h3>
            </div>
            <ul class="holo-list">
              <li>Beat automated screens: avoid silent ATS rejections.</li>
              <li>Tailor faster: add the right keywords without guesswork.</li>
              <li>Show impact: rewrite bullets with measurable results.</li>
              <li>Iterate quickly: measure changes with subscores + total score.</li>
              <li><em>Pro tip:</em> Keep resume to 1 page (early career) or 2 pages (10+ yrs) with strong recent impact.
              </li>
            </ul>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="holo-card sa fade-up eq" data-sa-delay="70">
            <div class="holo-head"><span class="holo-emoji">üìä</span>
              <h3>How we score</h3>
            </div>
            <p class="text-muted mb-2">Your total is a weighted blend of five subscores (0‚Äì100 each):</p>
            <ul class="holo-list narrow">
              <li><strong>ATS readiness (25%)</strong> ‚Äî headings, formatting, parsability.</li>
              <li><strong>Match (25%)</strong> ‚Äî alignment to role keywords.</li>
              <li><strong>Skills (20%)</strong> ‚Äî coverage of must‚Äëhave tools & tech.</li>
              <li><strong>Readability (15%)</strong> ‚Äî clarity, concision, tone.</li>
              <li><strong>Structure (15%)</strong> ‚Äî bullet quality, tense consistency, layout.</li>
            </ul>
            <div class="ai-formula">Total = 0.25√óATS + 0.25√óMatch + 0.20√óSkills + 0.15√óReadability + 0.15√óStructure
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="holo-card sa fade-up">
          <div class="holo-head"><span class="holo-emoji">‚úçÔ∏è</span>
            <h3>How to improve</h3>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="holo-list">
                <li><strong>Show impact:</strong> Use "Action + task + metric" (e.g., "Increased activation by 18% ‚Ä¶").
                </li>
                <li><strong>Fix ATS blockers:</strong> Clear headings, consistent bullets, no images‚Äëof‚Äëtext, standard
                  fonts.</li>
                <li><strong>Add must‚Äëhaves:</strong> Cover missing keywords in Skills and in relevant bullets.</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="holo-list">
                <li><strong>Tighten writing:</strong> Short sentences, active verbs, remove filler/buzzwords.</li>
                <li><strong>Prioritize recency:</strong> Add most detail to the latest role (4‚Äì6 bullets).</li>
                <li><strong>Re‚Äëscore:</strong> Tailor per job; re‚Äëcheck after edits.</li>
              </ul>
            </div>
          </div>
          <div class="ai-scan thin" aria-hidden="true"></div>
        </div>
      </div>

      <div class="col-12">
        <div class="holo-card subtle sa fade-up">
          <div class="holo-head"><span class="holo-emoji">üîí</span>
            <h3>Privacy & Security</h3>
          </div>
          <p class="text-muted mb-0">Uploads are encrypted in transit. You control retention (auto‚Äëdelete option). We
            never sell personal data.</p>
        </div>
      </div>
    </div>
  </div>
  </div>
</section>


<!-- CONTEXT -->
<section id="contextBlock" class="section-dark py-4 d-none">
  <div class="container">
    <div class="mx-auto" style="max-width: 1100px;">
      <div class="p-3 mb-4"
        style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; color:#e5e7eb; backdrop-filter:blur(8px) saturate(130%);">
        <h4 class="text-primary fw-bold mb-2">What we analyzed</h4>
        <ul id="analyzedList" class="text-muted mb-0"></ul>
      </div>
      <div class="p-3 mb-4"
        style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; color:#e5e7eb; backdrop-filter:blur(8px) saturate(130%);">
        <h4 class="text-primary fw-bold mb-2">How we calculate your score</h4>
        <p class="text-muted">Your total is a weighted blend of 5 subscores (normalized 0‚Äì100).</p>
        <ul id="calcList" class="text-muted mb-2"></ul>
        <div class="small text-muted">
          Example: <code
            style="background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.08);padding:2px 6px;border-radius:6px;">Total = 0.25√óATS + 0.25√óMatch + 0.20√óSkills + 0.15√óReadability + 0.15√óStructure</code>
        </div>
      </div>
      <div class="p-3"
        style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; color:#e5e7eb; backdrop-filter:blur(8px) saturate(130%);">
        <div class="d-flex align-items-center justify-content-between">
          <h4 class="text-primary fw-bold mb-2">How to improve</h4>
          <button id="copyImprove" class="btn btn-sm btn-outline-light"><i class="bi bi-clipboard"></i> Copy
            tips</button>
        </div>
        <ul id="improveList" class="text-muted mb-0"></ul>
      </div>
    </div>
  </div>
</section>

<!-- Firebase Config -->
<script src="{% static 'js/firebase-config.js' %}"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  // Initialize Firebase using the config from firebase-config.js
  const app = initializeApp(window.firebaseConfig);

  // Initialize services
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Make these available to the existing script
  window.firebaseAuth = { auth };
  window.firebaseStorage = { getStorage, ref, uploadBytesResumable, getDownloadURL, storage };
  window.firebaseFirestore = { db, collection, addDoc, serverTimestamp };
</script>

<!-- Real Scoring JavaScript -->
<script>
  // ===== Score Checker: real scoring + UI render =====
  (() => {
    const dz = document.getElementById('checkerDrop');
    const input = document.getElementById('checkerInput');
    const browse = document.getElementById('checkerBrowse');
    const fileList = document.getElementById('checkerFiles');
    const btn = document.getElementById('checkScoreBtn');

    const results = document.getElementById('scoreResults');
    const context = document.getElementById('contextBlock') || document.getElementById('score-context');

    // Diagram elements
    const donut = document.getElementById('donut');
    const donutVal = document.getElementById('donutValue');
    const barATS = document.getElementById('barATS');
    const barMatch = document.getElementById('barMatch');
    const barSkills = document.getElementById('barSkills');
    const barRead = document.getElementById('barRead');
    const barStruct = document.getElementById('barStruct');
    const chipsPresent = document.getElementById('chipsPresent');
    const chipsMissing = document.getElementById('chipsMissing');
    const insightsList = document.getElementById('insightsList');

    const emoji3d = document.getElementById('emoji3d');
    const emojiChar = document.getElementById('emojiChar') || (emoji3d?.querySelector('.emoji-char'));
    const verdictText = document.getElementById('verdictText') || document.querySelector('#verdict .verdict-text');

    // Context lists
    const analyzedList = document.getElementById('analyzedList');
    const calcList = document.getElementById('calcList');
    const improveList = document.getElementById('improveList');
    const copyImprove = document.getElementById('copyImprove');

    // Dropzone UI
    let files = [];
    const renderFiles = () => {
      fileList.innerHTML = '';
      files.forEach((f, i) => {
        const el = document.createElement('div');
        el.className = 'dz-file';
        el.innerHTML = `<i class="bi bi-file-earmark-text"></i><span>${f.name}</span> <button type="button" class="btn btn-sm btn-link text-danger p-0">Remove</button>`;
        el.querySelector('button').addEventListener('click', () => { files.splice(i, 1); renderFiles(); });
        fileList.appendChild(el);
      });
      btn.disabled = files.length === 0;
    };
    browse?.addEventListener('click', () => input.click());
    input?.addEventListener('change', e => { files = Array.from(e.target.files || []); renderFiles(); });
    dz?.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('active'); });
    dz?.addEventListener('dragleave', () => dz.classList.remove('active'));
    dz?.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('active');
      if (e.dataTransfer?.files?.length) { files = Array.from(e.dataTransfer.files); renderFiles(); }
    });

    // Helpers
    const ring = t => t >= 80 ? '#22c55e' : t >= 65 ? '#f59e0b' : '#ef4444';
    const verdict = t => t >= 85 ? { mood: 'good', emoji: 'üòÑ', text: 'Excellent fit ‚Äî ready to apply!' }
      : t >= 75 ? { mood: 'good', emoji: 'üôÇ', text: 'Good ‚Äî a few quick improvements recommended.' }
        : t >= 60 ? { mood: 'bad', emoji: 'üòï', text: 'Fair ‚Äî add metrics and keywords to boost.' }
          : { mood: 'bad', emoji: 'üò¨', text: 'Needs work ‚Äî fix ATS issues and add impact.' };
    const getCsrf = () => (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';

    copyImprove?.addEventListener('click', async () => {
      const text = Array.from(document.querySelectorAll('#improveList li')).map(li => '‚Ä¢ ' + li.textContent).join('\n');
      try { await navigator.clipboard.writeText(text); } catch { }
    });

    // Render helper (and call AI effects if present)
    function render(data) {
      // Reveal results section
      document.getElementById('scoreResults').classList.remove('d-none');
      document.getElementById('scoreResults').scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Animate Donut
      const score = data.total || 0;
      const donutFill = document.getElementById('donutFill');
      const donutValue = document.getElementById('donutValue');
      const radius = 45;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (score / 100) * circumference;

      donutFill.style.strokeDasharray = `${circumference} ${circumference}`;
      donutFill.style.strokeDashoffset = circumference;

      // Trigger transition
      setTimeout(() => {
        donutFill.style.strokeDashoffset = offset;
        let startScore = 0;
        const duration = 1500;
        const stepTime = Math.abs(Math.floor(duration / score));
        const timer = setInterval(() => {
          startScore++;
          donutValue.textContent = startScore;
          if (startScore >= score) clearInterval(timer);
        }, stepTime);
      }, 100);

      // Map subscores (API: ats, match, skills, read, struct)
      // To UI: barEdu, barExp, barSkills, barATS
      const subscores = {
        Edu: data.read || 75,
        Exp: data.struct || 70,
        Skills: data.skills || 65,
        ATS: data.ats || 80
      };

      Object.keys(subscores).forEach(key => {
        const val = subscores[key];
        const bar = document.getElementById(`bar${key}`);
        const label = document.getElementById(`score${key}`);
        if (bar) bar.style.width = `${val}%`;
        if (label) label.textContent = `${val}%`;
      });

      // Verdict text
      const v = score >= 85 ? 'Excellent! Your resume is highly competitive.'
        : score >= 75 ? 'Good. A few minor tweaks could make it stand out.'
          : score >= 60 ? 'Fair. Consider adding more measurable results.'
            : 'Needs improvement. Focus on key sections and structure.';
      document.getElementById('verdictText').textContent = v;

      // AI Feedback Text
      const feedback = `
      <p>Based on our AI analysis, your resume has a <strong>${score}%</strong> overall score. 
      Your <strong>${subscores.ATS}% ATS compatibility</strong> suggests it is well-formatted for automated systems. 
      However, enhancing your <strong>${subscores.Skills}% Skill coverage</strong> by adding more industry-specific keywords could further improve your visibility to recruiters.</p>
      <p>Recommended next step: Use our <strong>Resume Review</strong> tool for a detailed breakdown of specific mistakes and AI-powered fixes.</p>
    `;
      document.getElementById('aiFeedback').innerHTML = feedback;

      // Call celebration effects
      if (window.aiDecor) window.aiDecor(score);
    }

    btn?.addEventListener('click', async () => {
      const file = files[0] || input?.files?.[0];
      if (!file) { alert('Please select a PDF/DOCX first.'); return; }

      // Validate file type
      const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      const ext = file.name.split('.').pop().toLowerCase();
      if (!allowedTypes.includes(file.type) && ext !== 'pdf' && ext !== 'docx') {
        alert('Only PDF and DOCX files are allowed.');
        return;
      }

      btn.disabled = true;
      const originalText = btn.innerHTML;

      try {
        // Firebase Auth
        const { auth } = window.firebaseAuth;
        const user = auth.currentUser;
        if (!user) {
          alert("Please sign in to analyze your resume.");
          btn.disabled = false;
          return;
        }

        // Firebase Storage Upload
        const { getStorage, ref, uploadBytesResumable, getDownloadURL, storage } = window.firebaseStorage;
        const { db, collection, addDoc, serverTimestamp } = window.firebaseFirestore;

        const timestamp = Date.now();
        const storagePath = `resumes/${user.uid}/${timestamp}_${file.name}`;
        const storageRef = ref(storage, storagePath);

        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Uploading: ${progress}%`;
          },
          (error) => {
            console.error("Upload failed:", error);
            alert("Upload failed: " + error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
          },
          async () => {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            console.log("File available at:", downloadURL);

            // Store metadata in Firestore
            try {
              await addDoc(collection(db, "resumes"), {
                userId: user.uid,
                filename: file.name,
                storagePath: storagePath,
                downloadURL: downloadURL,
                uploadedAt: serverTimestamp(),
                status: "uploaded"
              });
            } catch (fsErr) {
              console.warn("Firestore metadata save failed:", fsErr);
            }

            // Continue to existing fake analysis flow
            btn.innerHTML = originalText;
            btn.disabled = false;

            const fakeData = {
              total: 82,
              ats: 88,
              skills: 75,
              read: 80,
              struct: 85,
              issues: [
                { title: 'Weak Action Verbs', severity: 'High', desc: 'Phrases like "Responsible for" or "Helped with" lack impact. Use verbs like "Spearheaded" or "Orchestrated".' },
                { title: 'Missing Quantifiable Metrics', severity: 'Medium', desc: 'Your experience bullet points lack numbers or percentages to demonstrate real impact.' },
                { title: 'ATS Header Formatting', severity: 'Low', desc: 'Contact information in headers/footers can sometimes be missed by older ATS scanners.' }
              ],
              suggestions: [
                'Add a "Professional Summary" section to grab attention in the first 6 seconds.',
                'Move your "Skills" section to the top for better keyword visibility.',
                'Use consistent date formatting (e.g., MM/YYYY) throughout the document.',
                'Ensure your contact info includes your LinkedIn profile URL.'
              ]
            };

            localStorage.setItem('simulatedAnalysis', JSON.stringify(fakeData));
            render(fakeData);
          }
        );

      } catch (err) {
        console.error("Firebase error:", err);
        alert("An error occurred during upload. Please check your Firebase configuration.");
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });
  })();
</script>

<!-- AI Effects JavaScript -->
<script>
  // ===== AI Effects: confetti for good score, warning rain for low score =====
  (() => {
    // Create fx layer once
    let fx = document.getElementById('aiFx');
    if (!fx) {
      fx = document.createElement('div');
      fx.id = 'aiFx';
      document.body.appendChild(fx);
    }

    function spawnEmojis(chars = ['üéâ', '‚ú®', 'üöÄ'], count = 28, anim = 'fall') {
      const w = window.innerWidth;
      const h = window.innerHeight;
      for (let i = 0; i < count; i++) {
        const s = document.createElement('span');
        s.className = 'emo';
        s.textContent = chars[i % chars.length];
        s.style.left = Math.random() * w + 'px';
        s.style.top = (-10 - Math.random() * 40) + 'px';
        s.style.animation = `${anim} ${1.6 + Math.random() * 1.2}s linear forwards`;
        fx.appendChild(s);
        setTimeout(() => s.remove(), 2200);
      }
    }

    // Public hook: call this after you compute the score
    window.aiDecor = (score = 75) => {
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      if (score >= 80) {
        spawnEmojis(['üéâ', '‚ú®', 'üöÄ'], 36, 'fall');
      } else if (score < 65) {
        spawnEmojis(['‚ö†Ô∏è', 'üò¨', 'üíß'], 28, 'float');
      } else {
        spawnEmojis(['üôÇ', '‚ú®'], 18, 'fall');
      }
    };

    // Optional auto‚Äëhook if your page already sets window.renderScoreResults
    const orig = window.renderScoreResults;
    if (typeof orig === 'function') {
      window.renderScoreResults = (payload) => {
        try {
          orig(payload);
        } finally {
          window.aiDecor(payload.total || 0);
        }
      };
    }
  })();
</script>

<!-- Equal Height JavaScript Fallback -->
<script>
  // ===== Equal-height fallback for AI context (per row) =====
  (() => {
    const grid = document.getElementById('aiEqGrid');
    if (!grid) return;

    let raf;
    function equalizeByRow() {
      // Reset any explicit heights
      grid.querySelectorAll('.holo-card').forEach(c => c.style.minHeight = '');
      // On mobile (stacked), skip
      if (window.matchMedia('(max-width: 991.98px)').matches) return;

      // Group cards by their top position (i.e., rows)
      const cards = Array.from(grid.querySelectorAll('.holo-card'));
      const rows = [];
      cards.forEach(c => {
        const top = Math.round(c.getBoundingClientRect().top);
        let row = rows.find(r => Math.abs(r.top - top) < 6);
        if (!row) rows.push(row = { top, cards: [] });
        row.cards.push(c);
      });
      // Set min-height to tallest for each row
      rows.forEach(r => {
        let maxH = 0;
        r.cards.forEach(c => maxH = Math.max(maxH, c.getBoundingClientRect().height));
        r.cards.forEach(c => c.style.minHeight = `${Math.ceil(maxH)}px`);
      });
    }
    const run = () => { cancelAnimationFrame(raf); raf = requestAnimationFrame(equalizeByRow); };

    window.addEventListener('load', run);
    window.addEventListener('resize', run);
    // If you use scroll-in animations, re-run after initial reveal
    setTimeout(run, 500);
  })();
</script>

<!-- Floating Action Button -->
<button id="fabNewScore" class="fab-newscore" title="Score another resume" aria-label="Score another resume">
  <i class="bi bi-plus-lg"></i>
</button>

{% endblock %}